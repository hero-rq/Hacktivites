-csrf

csrf는 xss와 비슷한 부분이 많습니다. 예를 들어, 원하는 스트립트를 삽입하여 이용자로 하여금 특정 공격을 유도한다는 점이 그렇죠. csrf와 xss에는 똑같이 크로스 사이트가 들어갑니다. 그리고 xss처럼 최근에 와서도 꾸준히 취약점과 공격 벡터가 발견되고 있는 취약점이기도 합니다. 

조금 더 풀어서 설명해볼까요? 
이용자가 어떤 특정 웹사이트에 로그인해놓은 상태를 유지하고 있다고 가정해봅시다. 공격자는 이용자에게 주로 이메일 등을 보내서 클릭을 하거나 특정 스크립트에 접근하도록 유도합니다. 이용자가 아무것도 모른 상태로 그 스크립트에 접근한 순간 그 스크립트가 실행되면서 이용자의 쿠키를 탈취하는 동시에 해당 웹 사이트의 비밀번호 등을 변경하도록 유도합니다. 그 웹 사이트 입장에서는 세션 정보를 정확히 제시하면서 비밀번호 변경을 요구하는 것이기 때문에 이용자의 정상적인 요구라 판단하고 원하는대로 비밀번호를 변경해줍니다. 그러면 공격자는 웹사이트에 들어가서 정상적으로 로그인을 하고 권한을 획득합니다. 
이게 어떻게 보면 csrf의 가장 기본적인 설명이라고 볼 수 있습니다. 다만, 이 글만 봐도 쉽게 떠올릴 수 있듯이, 공격자가 이용자로 하여금 특정 스크립트를 실행하게끔 유도하는데에는 정말 많은 방식이 있을 수 있습니다. 
조금 더 소스코드를 보면서 설명해볼까요? 



<html>
<meta charset = “UTF-8”>
<head>
</head> 

<script language=“javascript”>

  functin poc() {

  var host = ‘128.725.214.2526’;



  var req_uri = “https://” + host + 
“/vuln/?username=admin&pw=1234&Change=Change”;
  var http = new XMLHttpRequest();
  xmlhttp.open(“GET”,req_uri,true);
  xmlhttp.withCredentials = “true”;
  xmlhttp.send();

  alert(‘Done!!;);
}

</script>


이해를 돕기 위해 제가 직접 정리한 자바스크립트 코드입니다. 
간단한 정리를 위해서 직접 쓴 것이기 때문에 구체적인 부분은 막 썼습니다. 예를 들어, var host 값이 그렇죠. 공격자들은 주로 이런 자바스크립트 공격 형태를 <body>에 또다른 ‘보여지는’ 부분과 합쳐서 이용자들에게 보냅니다. <body> 부분에는 최대한 유혹할 수 있을만한 내용을 적거나 자연스러워 보이는 내용으로 구성해놓습니다. 예를 들어 “돈을 벌고싶나요?” 뭐 이런 내용 같은 거 말이죠. 이용자가 눌렀을 때 위에 정리해놓은 스크립트가 뒤에서 몰래 실행됩니다.   

“/vuln/?username=admin&pw=1234&Change=Change”;

  xmlhttp.withCredentials = “true”;

이 소스코드에서 가장 주의깊게 보셔야 하는 부분이 바로 이 부분입니다. 나머지 부분은 무시하셔도 좋습니다. withCredentials 속성이 바로 true이기 때문에 요청이 전송될 때 쿠키 역시 자동으로 전송됩니다. 기본적인 설명해서 했던 말 기억하시나요? 세션 정보가 저장되면서 pw 변경에 대한 요청이 동시에 가기 때문에 해당 웹 페이지 입장에서는 그 사용자의 패스워드 변경 요청과 구분할 수 없게 됩니다. 즉 정상적인 요청이라고 판단하는 것이죠.  
이런 식으로 간단하게 쿠키를 보내면서 동시에 패스워드 변경 요청을 할 수 있고 공격자는 해당 패스워드로 로그인하여 권한을 획득할 수 있습니다. 바로 이것이 csrf 공격인 것이죠. 

그러면 (xss에서도 보았듯이) csrf에 효과적인 대응방식은 과연 무엇일까요? 
xss랑 비슷한 측면이 있으니 해결방식도 비슷하다고 생각할 수 있지만, 이는 악의적인 스크립트가 있는 곳으로 순진한 이용자들을 유인하여 실행시키는 것이기 때문에 xss의 해결방안하고는 사실 별로 상관이 없습니다. 
가장 기본은 일단 메일 혹은 모르는 사이트 등에 함부로 들어가지 않는 것입니다. 이러한 태도는 악성코드 혹은 랜섬웨어 대처에도 가장 기본이 되는 요소이기도 하죠. 가장 좋은 방어 형태는 예방입니다. 
그 다음 자주 거론되는 방법은 레퍼러 헤더를 검사하는 것입니다. 그렇지만, 실무에서는 이미 이 방법은 거의 폐기처분된 방법이기도 합니다. 별다른 효과가 없다는 것이 검증되었기 때문이죠. 해커들은 이미 이것까지도 자유자재로 가지고 놀 수 있을 정도로 공격 형태를 발전시켰습니다. 

현실적으로 매우 효과적인 방법은 csrf 토큰을 사용하는 것입니다. 공격자가 예측할 수 없는 값을 파라미터에 포함시키면 csrf 공격 성공률이 현저하게 떨어집니다.  

  
Title : Basic Lectures for White Hackers 

a publishing house : Bookk Publisher

isbn : 9791137283008

Author : ME 
